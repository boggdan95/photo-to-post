{% extends "base.html" %}
{% block title_extra %} - Programar{% endblock %}

{% block extra_css %}
<style>
    .schedule-container { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
    @media (max-width: 900px) { .schedule-container { grid-template-columns: 1fr; } }

    .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #4361ee; }

    /* Preview list */
    .preview-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .preview-item {
        display: flex; align-items: center; gap: 1rem;
        padding: 0.75rem; background: #f8f9fa; border-radius: 6px;
        border-left: 4px solid #4361ee;
    }
    .preview-item .date-time { min-width: 140px; font-weight: 600; color: #4361ee; }
    .preview-item .location { flex: 1; }
    .preview-item .country { background: #e8eaf6; color: #4361ee; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; }
    .preview-item .photos { color: #999; font-size: 0.85rem; }

    /* Calendar */
    .calendar { background: #fff; border-radius: 8px; }
    .calendar-month { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
    .calendar-header { text-align: center; font-weight: 600; padding: 0.5rem; background: #1a1a2e; color: #fff; font-size: 0.8rem; }
    .calendar-day {
        min-height: 80px; padding: 0.25rem; border: 1px solid #eee; background: #fff;
        font-size: 0.75rem; position: relative;
    }
    .calendar-day.other-month { background: #f5f5f5; color: #ccc; }
    .calendar-day.today { background: #fff9e6; }
    .calendar-day .day-number { font-weight: 600; margin-bottom: 0.25rem; }
    .calendar-event {
        background: #4361ee; color: #fff; padding: 2px 4px; border-radius: 3px;
        font-size: 0.65rem; margin-bottom: 2px; overflow: hidden;
        text-overflow: ellipsis; white-space: nowrap;
    }
    .calendar-event.published { background: #2ec4b6; }
    .calendar-event.preview { background: #ffd166; color: #333; border: 1px dashed #999; }

    /* Config summary */
    .config-summary { background: #f8f9fa; padding: 1rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.9rem; }
    .config-summary span { margin-right: 1.5rem; }
    .config-summary strong { color: #4361ee; }

    /* Actions */
    .actions { margin-top: 1.5rem; display: flex; gap: 1rem; align-items: center; }
    .empty-state { color: #999; padding: 2rem; text-align: center; }

    /* Instagram Grid Preview */
    .instagram-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 3px; }
    .grid-cell {
        aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
        font-size: 0.7rem; font-weight: 600; color: #fff; text-align: center;
        border-radius: 2px; padding: 4px; position: relative; overflow: hidden;
    }
    .grid-cell .country-name { position: relative; z-index: 1; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
    .grid-cell .post-num { position: absolute; top: 2px; left: 4px; font-size: 0.6rem; opacity: 0.8; }
    .grid-cell.published { opacity: 0.5; }
    .grid-row-marker { grid-column: span 3; text-align: center; font-size: 0.7rem; color: #999; padding: 0.25rem; background: #f5f5f5; }
</style>
{% endblock %}

{% block content %}
<h1>Programar Posts</h1>

<div class="config-summary">
    <span><strong>{{ settings.posts_per_week }}</strong> posts/semana</span>
    <span>Horarios: <strong>{{ settings.preferred_times | join(', ') }}</strong></span>
    <span>Modo: <strong>{{ 'Grid (3x3 por pais)' if settings.grid_mode else 'Diversificado' }}</strong></span>
</div>

{% if preview %}
<div class="schedule-container">
    <!-- Preview column -->
    <div>
        <div class="section-title">Preview de programacion ({{ preview|length }} posts)</div>
        <div class="preview-list">
            {% for item in preview %}
            <div class="preview-item">
                <div class="date-time">{{ item.scheduled_date }}<br>{{ item.scheduled_time }}</div>
                <div class="location">{{ item.location }}</div>
                <span class="country">{{ item.country }}</span>
                <span class="photos">{{ item.photos }} fotos</span>
            </div>
            {% endfor %}
        </div>

        <div class="actions">
            <button class="btn btn-success" onclick="confirmSchedule()">Confirmar programacion</button>
            <span style="color:#999;font-size:0.85rem;">Esto movera los posts a "Programados"</span>
        </div>
    </div>

    <!-- Calendar column -->
    <div>
        <div class="section-title">Calendario</div>
        <div class="card calendar" id="calendar"></div>
    </div>
</div>

<!-- Grid Preview -->
<div style="margin-top: 2rem;">
    <div class="section-title">Preview del Grid de Instagram</div>
    <p style="color:#666;font-size:0.85rem;margin-bottom:1rem;">Asi se veria tu perfil con los posts programados (los mas recientes arriba)</p>
    <div class="card" style="padding: 1rem; max-width: 500px;">
        <div class="instagram-grid" id="instagram-grid"></div>
    </div>
</div>
{% else %}
<div class="card empty-state">
    <p>No hay posts aprobados para programar.</p>
    <p style="margin-top:0.5rem;"><a href="/approved">Ver posts aprobados</a> o <a href="/review">revisar borradores</a>.</p>
</div>
{% endif %}

{% if calendar and not preview %}
<div style="margin-top: 2rem;">
    <div class="section-title">Posts ya programados/publicados</div>
    <div class="card calendar" id="calendar" style="max-width: 800px;"></div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
const calendarData = {{ calendar | tojson | safe }};
const previewData = {{ preview | tojson | safe }};

function renderCalendar() {
    const container = document.getElementById('calendar');
    if (!container) return;

    // Combine calendar data with preview
    const allEvents = {...calendarData};
    previewData.forEach(p => {
        if (!allEvents[p.scheduled_date]) allEvents[p.scheduled_date] = [];
        allEvents[p.scheduled_date].push({
            ...p,
            time: p.scheduled_time,
            status: 'preview'
        });
    });

    // Get date range
    const dates = Object.keys(allEvents).sort();
    const today = new Date();
    const startDate = dates.length ? new Date(dates[0]) : today;
    const endDate = dates.length ? new Date(dates[dates.length - 1]) : today;

    // Adjust to show full months
    startDate.setDate(1);
    endDate.setMonth(endDate.getMonth() + 1, 0);

    // Build calendar HTML
    let html = '<div class="calendar-month">';
    html += ['Dom', 'Lun', 'Mar', 'Mie', 'Jue', 'Vie', 'Sab'].map(d =>
        `<div class="calendar-header">${d}</div>`
    ).join('');

    // Start from first day of the week
    const current = new Date(startDate);
    current.setDate(current.getDate() - current.getDay());

    while (current <= endDate || current.getDay() !== 0) {
        const dateStr = current.toISOString().split('T')[0];
        const isOtherMonth = current.getMonth() !== startDate.getMonth() && current < startDate;
        const isToday = dateStr === today.toISOString().split('T')[0];

        let classes = 'calendar-day';
        if (isOtherMonth) classes += ' other-month';
        if (isToday) classes += ' today';

        let eventsHtml = '';
        if (allEvents[dateStr]) {
            allEvents[dateStr].forEach(e => {
                const statusClass = e.status === 'published' ? 'published' : (e.status === 'preview' ? 'preview' : '');
                eventsHtml += `<div class="calendar-event ${statusClass}" title="${e.location}">${e.time} ${e.country || e.location}</div>`;
            });
        }

        html += `<div class="${classes}">
            <div class="day-number">${current.getDate()}</div>
            ${eventsHtml}
        </div>`;

        current.setDate(current.getDate() + 1);
    }

    html += '</div>';
    container.innerHTML = html;
}

async function confirmSchedule() {
    if (!confirm('Confirmar la programacion de {{ preview|length }} posts?')) return;

    try {
        const res = await fetch('/api/schedule/confirm', {method: 'POST'});
        const data = await res.json();
        if (data.ok) {
            alert(`${data.count} posts programados exitosamente!`);
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

renderCalendar();
renderInstagramGrid();

function renderInstagramGrid() {
    const container = document.getElementById('instagram-grid');
    if (!container) return;

    // Country colors
    const countryColors = {};
    const colorPalette = [
        '#4361ee', '#2ec4b6', '#e63946', '#f4a261', '#9b5de5',
        '#00b4d8', '#80b918', '#ff6b6b', '#4ecdc4', '#ffe66d'
    ];
    let colorIdx = 0;

    function getColor(country) {
        if (!countryColors[country]) {
            countryColors[country] = colorPalette[colorIdx % colorPalette.length];
            colorIdx++;
        }
        return countryColors[country];
    }

    // Combine preview (upcoming) with recent published posts
    // Preview posts go first (they'll be at top = most recent)
    const gridPosts = [];

    // Add preview posts (reversed so first to post is at bottom)
    const previewReversed = [...previewData].reverse();
    previewReversed.forEach((p, i) => {
        gridPosts.push({
            country: p.country,
            location: p.location,
            status: 'preview',
            num: previewData.length - i
        });
    });

    // Render grid (show up to 12 posts = 4 rows)
    const postsToShow = gridPosts.slice(0, 12);

    // Reverse again so newest is at top
    postsToShow.reverse();

    let html = '';
    postsToShow.forEach((post, idx) => {
        const bg = getColor(post.country);
        const statusClass = post.status === 'published' ? 'published' : '';
        html += `<div class="grid-cell ${statusClass}" style="background: ${bg};" title="${post.location}">
            <span class="post-num">#${post.num}</span>
            <span class="country-name">${post.country}</span>
        </div>`;

        // Add row marker every 3 posts
        if ((idx + 1) % 3 === 0 && idx < postsToShow.length - 1) {
            html += `<div class="grid-row-marker">â†‘ Fila ${Math.floor(idx / 3) + 1}</div>`;
        }
    });

    // If we have less than 3 posts, pad with empty cells
    const remainder = postsToShow.length % 3;
    if (remainder > 0) {
        for (let i = 0; i < 3 - remainder; i++) {
            html += `<div class="grid-cell" style="background: #eee;"></div>`;
        }
    }

    container.innerHTML = html || '<p style="color:#999;text-align:center;padding:1rem;">No hay posts para mostrar</p>';

    // Add legend
    const legend = document.createElement('div');
    legend.style.cssText = 'margin-top: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem;';
    legend.innerHTML = Object.entries(countryColors).map(([country, color]) =>
        `<span style="display:inline-flex;align-items:center;gap:0.25rem;font-size:0.75rem;">
            <span style="width:12px;height:12px;background:${color};border-radius:2px;"></span>${country}
        </span>`
    ).join('');
    container.parentElement.appendChild(legend);
}
</script>
{% endblock %}
