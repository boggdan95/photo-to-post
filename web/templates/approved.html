{% extends "base.html" %}
{% block title_extra %} - Aprobados{% endblock %}

{% block extra_css %}
<style>
    .posts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 1.5rem; }
    .post-card { position: relative; }
    .post-card .photos-strip { display: flex; gap: 4px; overflow-x: auto; padding: 4px; background: #000; }
    .post-card .photos-strip img { height: 160px; width: auto; object-fit: cover; border-radius: 4px; }
    .post-card .photo-number {
        position: absolute; top: 8px; left: 8px;
        background: rgba(0,0,0,0.7); color: #fff;
        font-size: 0.7rem; padding: 2px 6px; border-radius: 4px;
    }
    .post-card .photo-wrapper { position: relative; display: inline-block; }
    .post-card .post-body { padding: 1rem; }
    .post-card .location { font-weight: 600; margin-bottom: 0.5rem; }
    .post-card .photo-count { color: #999; font-size: 0.85rem; }
    .caption-text { font-size: 0.9rem; color: #333; margin: 0.5rem 0; line-height: 1.4; }
    .hashtags { font-size: 0.8rem; color: #4361ee; margin-top: 0.5rem; }
</style>
{% endblock %}

{% block content %}
<h1>Posts Aprobados</h1>

{% if posts %}
<div class="posts-grid">
{% for post in posts %}
    <div class="card post-card" data-post-id="{{ post.id }}">
        <div class="photos-strip">
            {% for photo in post.photos %}
            <div class="photo-wrapper">
                <img src="/api/photo/{{ post.id }}/{{ photo.filename }}" alt="{{ photo.filename }}">
                <span class="photo-number">{{ loop.index }}</span>
            </div>
            {% endfor %}
        </div>
        <div class="post-body">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="location">{{ post.location_display }}</span>
                <span class="badge badge-approved">aprobado</span>
            </div>
            <span class="photo-count">{{ post.photos|length }} fotos</span>
            <div class="caption-text">{{ post.caption.text }}</div>
            <div class="hashtags">{{ post.caption.hashtags | join(' ') }}</div>
            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                <button class="btn btn-primary btn-sm" onclick="publishNow('{{ post.id }}', this)">Publicar ahora</button>
                <button class="btn btn-sm" style="background:#666;color:#fff;" onclick="unapprove('{{ post.id }}')" title="Regresar a Review para editar">Editar</button>
            </div>
        </div>
    </div>
{% endfor %}
</div>
{% else %}
<div class="empty-state">
    <p>No hay posts aprobados.</p>
    <p style="margin-top:0.5rem;font-size:0.9rem;">Aprueba borradores desde <a href="/review">Review</a>.</p>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
async function unapprove(postId) {
    if (!confirm('Regresar este post a Review para editarlo?')) return;

    try {
        const res = await fetch(`/api/post/${postId}/unapprove`, {method: 'POST'});
        const data = await res.json();
        if (data.ok) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

async function publishNow(postId, btn) {
    if (!confirm('Publicar este post ahora en Instagram?')) return;

    btn.disabled = true;
    btn.textContent = 'Publicando...';

    try {
        const res = await fetch(`/api/post/${postId}/publish-now`, {method: 'POST'});
        const data = await res.json();

        if (data.ok) {
            alert('Publicado exitosamente en Instagram!');
            location.reload();
        } else {
            alert('Error: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            btn.textContent = 'Publicar ahora';
        }
    } catch (e) {
        alert('Error: ' + e.message);
        btn.disabled = false;
        btn.textContent = 'Publicar ahora';
    }
}
</script>
{% endblock %}
