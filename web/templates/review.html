{% extends "base.html" %}
{% block title_extra %} - Review{% endblock %}

{% block extra_css %}
<style>
    .posts-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 1.5rem; }
    .post-card { position: relative; }
    .post-card .photos-strip { display: flex; gap: 4px; overflow-x: auto; padding: 4px; background: #000; }
    .post-card .photos-strip .photo-wrapper { position: relative; display: inline-block; }
    .post-card .photos-strip img { height: 180px; width: auto; object-fit: cover; border-radius: 4px; cursor: grab; }
    .post-card .photos-strip img.dragging { opacity: 0.4; }
    .photo-delete { position: absolute; top: 4px; right: 4px; background: rgba(230,57,70,0.9); color: #fff; border: none; border-radius: 50%; width: 22px; height: 22px; cursor: pointer; font-size: 14px; line-height: 20px; display: none; }
    .photo-wrapper:hover .photo-delete { display: block; }
    .post-card .post-body { padding: 1rem; }
    .post-card .location { font-weight: 600; margin-bottom: 0.5rem; }
    .post-card .photo-count { color: #999; font-size: 0.85rem; }
    .caption-area { width: 100%; border: 1px solid #ddd; border-radius: 6px; padding: 0.5rem; font-size: 0.9rem; resize: vertical; min-height: 60px; font-family: inherit; }
    .hashtags-area { width: 100%; border: 1px solid #ddd; border-radius: 6px; padding: 0.5rem; font-size: 0.8rem; color: #4361ee; resize: none; min-height: 40px; font-family: inherit; margin-top: 0.5rem; }
    .post-actions { display: flex; gap: 0.5rem; margin-top: 0.75rem; align-items: center; }
    .post-check { width: 18px; height: 18px; }
    .bulk-bar { background: #1a1a2e; color: #fff; padding: 1rem 2rem; border-radius: 8px; margin-bottom: 1.5rem; display: flex; justify-content: space-between; align-items: center; }
    .save-indicator { font-size: 0.75rem; color: #2ec4b6; display: none; margin-left: 0.5rem; }

    /* Expand post button */
    .expand-btn { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: #fff; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; z-index: 5; }
    .expand-btn:hover { background: rgba(0,0,0,0.9); }

    /* View modal */
    .view-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; overflow-y: auto; }
    .view-modal.visible { display: block; }
    .view-modal-content { max-width: 1000px; margin: 2rem auto; padding: 0 1rem; }
    .view-modal-close { position: fixed; top: 20px; right: 30px; color: #fff; font-size: 2rem; cursor: pointer; z-index: 1001; }
    .view-modal-photos { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 12px; margin-bottom: 1.5rem; }
    .view-modal-photos img { width: 100%; height: 280px; object-fit: cover; border-radius: 8px; }
    .view-modal-info { background: #fff; padding: 1.5rem; border-radius: 10px; }
    .view-modal-info h2 { margin: 0 0 1rem 0; }
    .view-modal-info textarea { width: 100%; border: 1px solid #ddd; border-radius: 6px; padding: 0.75rem; font-size: 1rem; resize: vertical; min-height: 100px; font-family: inherit; }
    .view-modal-info .hashtags-edit { min-height: 60px; color: #4361ee; margin-top: 0.75rem; }
    .view-modal-actions { margin-top: 1rem; display: flex; gap: 0.5rem; }

    /* Split modal */
    .split-modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
    .split-modal.visible { display: flex; }
    .split-modal-content { background: #fff; border-radius: 10px; max-width: 900px; width: 95%; max-height: 90vh; overflow-y: auto; }
    .split-modal-header { padding: 1rem; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
    .split-modal-header h3 { margin: 0; }
    .split-modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; }
    .split-modal-body { padding: 1rem; }
    .split-instructions { background: #f0f7ff; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; font-size: 0.9rem; }
    .split-photos { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 1rem; }
    .split-photo { position: relative; cursor: pointer; }
    .split-photo img { width: 120px; height: 120px; object-fit: cover; border-radius: 6px; border: 3px solid transparent; }
    .split-photo.selected img { border-color: #e63946; }
    .split-photo .photo-label { position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.7); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 0.75rem; }
    .split-photo.selected .photo-label { background: #e63946; }
    .split-summary { display: flex; gap: 2rem; margin: 1rem 0; }
    .split-summary div { padding: 0.5rem 1rem; background: #f5f5f5; border-radius: 6px; }
    .split-summary .count { font-weight: 700; color: #4361ee; }
    .split-summary .warn { color: #e63946; }
    .split-modal-footer { padding: 1rem; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 0.5rem; }
</style>
{% endblock %}

{% block content %}
<h1>Review Drafts</h1>

{% if posts %}
<div class="bulk-bar">
    <label><input type="checkbox" id="select-all"> Seleccionar todos</label>
    <div>
        <button class="btn btn-success btn-sm" onclick="approveBulk()">Aprobar seleccionados</button>
    </div>
</div>

<div class="posts-grid">
{% for post in posts %}
    <div class="card post-card" data-post-id="{{ post.id }}">
        <button class="expand-btn" onclick="openViewModal('{{ post.id }}')" title="Ver en grande">â›¶ Ver</button>
        <div class="photos-strip" id="strip-{{ post.id }}">
            {% for photo in post.photos %}
            <div class="photo-wrapper">
                <img src="/api/photo/{{ post.id }}/{{ photo.filename }}"
                     alt="{{ photo.filename }}"
                     draggable="true"
                     data-filename="{{ photo.filename }}">
                <button class="photo-delete" onclick="deletePhoto('{{ post.id }}', '{{ photo.filename }}')" title="Eliminar foto">&times;</button>
            </div>
            {% endfor %}
        </div>
        <div class="post-body">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="location">{{ post.location_display }}</span>
                <span class="badge badge-draft">{{ post.status }}</span>
            </div>
            <span class="photo-count">{{ post.photos|length }} fotos</span>

            <div style="display:flex;gap:0.5rem;align-items:flex-start;">
                <textarea class="caption-area" data-post-id="{{ post.id }}" style="flex:1;"
                          onchange="saveCaption(this)">{{ post.caption.text }}</textarea>
                <button class="btn btn-sm" style="background:#666;color:#fff;font-size:0.7rem;padding:0.3rem 0.5rem;"
                        onclick="regenerateCaption('{{ post.id }}')" title="Regenerar caption con IA">ðŸ”„ IA</button>
            </div>
            <span class="save-indicator" id="saved-{{ post.id }}">Guardado</span>

            <textarea class="hashtags-area" data-post-id="{{ post.id }}"
                      onchange="saveHashtags(this)">{{ post.caption.hashtags | join(' ') }}</textarea>

            <div class="post-actions">
                <input type="checkbox" class="post-check" value="{{ post.id }}">
                <button class="btn btn-success btn-sm" onclick="approveOne('{{ post.id }}')">Aprobar</button>
                <button class="btn btn-danger btn-sm" onclick="rejectOne('{{ post.id }}')">Rechazar</button>
                {% if post.photos|length >= 6 %}
                <button class="btn btn-primary btn-sm" onclick="openSplitModal('{{ post.id }}')" title="Dividir en 2 posts">Dividir</button>
                {% endif %}
            </div>
        </div>
    </div>
{% endfor %}
</div>
{% else %}
<div class="empty-state">
    <p>No hay borradores para revisar.</p>
    <p style="margin-top:0.5rem;font-size:0.9rem;">Ejecuta <code>python run.py create-posts</code> para generar borradores.</p>
</div>
{% endif %}

<!-- View Modal -->
<div class="view-modal" id="view-modal">
    <span class="view-modal-close" onclick="closeViewModal()">&times;</span>
    <div class="view-modal-content">
        <div class="view-modal-photos" id="view-modal-photos"></div>
        <div class="view-modal-info">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem;">
                <h2 id="view-modal-location" style="margin:0;"></h2>
                <button class="btn btn-sm" style="background:#666;color:#fff;" onclick="regenerateCaptionFromView()">ðŸ”„ Regenerar caption</button>
            </div>
            <textarea id="view-modal-caption" onchange="saveViewCaption()"></textarea>
            <textarea class="hashtags-edit" id="view-modal-hashtags" onchange="saveViewHashtags()"></textarea>
            <div class="view-modal-actions">
                <button class="btn btn-success" onclick="approveFromView()">Aprobar</button>
                <button class="btn btn-danger" onclick="rejectFromView()">Rechazar</button>
                <button class="btn btn-primary" id="view-split-btn" style="display:none;" onclick="closeViewModal(); openSplitModal(viewPostId);">Dividir</button>
            </div>
        </div>
    </div>
</div>

<!-- Split Modal -->
<div class="split-modal" id="split-modal">
    <div class="split-modal-content">
        <div class="split-modal-header">
            <h3>Dividir Post</h3>
            <button class="split-modal-close" onclick="closeSplitModal()">&times;</button>
        </div>
        <div class="split-modal-body">
            <div class="split-instructions">
                Haz clic en las fotos que quieres <strong>mover al nuevo post</strong>. Las fotos no seleccionadas se quedan en el post original.
            </div>
            <div class="split-photos" id="split-photos"></div>
            <div class="split-summary">
                <div>Post original: <span class="count" id="split-keep">0</span> fotos</div>
                <div>Nuevo post: <span class="count" id="split-move">0</span> fotos</div>
            </div>
            <div id="split-warning" style="color:#e63946;font-size:0.9rem;display:none;">
                Ambos posts deben tener al menos 3 fotos.
            </div>
        </div>
        <div class="split-modal-footer">
            <button class="btn" style="background:#666;color:#fff;" onclick="closeSplitModal()">Cancelar</button>
            <button class="btn btn-primary" id="split-confirm-btn" onclick="confirmSplit()">Dividir</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Select all checkbox
document.getElementById('select-all')?.addEventListener('change', function() {
    document.querySelectorAll('.post-check').forEach(cb => cb.checked = this.checked);
});

// Save caption
function saveCaption(el) {
    const postId = el.dataset.postId;
    fetch(`/api/post/${postId}/caption`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text: el.value})
    }).then(() => {
        const ind = document.getElementById(`saved-${postId}`);
        ind.style.display = 'inline';
        setTimeout(() => ind.style.display = 'none', 2000);
    });
}

// Regenerate caption with AI
async function regenerateCaption(postId) {
    if (!confirm('Regenerar caption con IA? El caption actual se perderÃ¡.')) return;

    try {
        const res = await fetch(`/api/post/${postId}/regenerate-caption`, {method: 'POST'});
        const data = await res.json();

        if (data.ok) {
            // Update textarea
            const card = document.querySelector(`[data-post-id="${postId}"]`);
            card.querySelector('.caption-area').value = data.caption;
            card.querySelector('.hashtags-area').value = data.hashtags.join(' ');

            const ind = document.getElementById(`saved-${postId}`);
            ind.textContent = 'Regenerado!';
            ind.style.display = 'inline';
            setTimeout(() => ind.style.display = 'none', 2000);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// Save hashtags
function saveHashtags(el) {
    const postId = el.dataset.postId;
    const tags = el.value.split(/\s+/).filter(t => t.startsWith('#'));
    fetch(`/api/post/${postId}/caption`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({hashtags: tags})
    });
}

// Approve one
function approveOne(postId) {
    if (!confirm('Aprobar este post?')) return;
    fetch(`/api/post/${postId}/approve`, {method: 'POST'})
        .then(r => r.json())
        .then(() => {
            document.querySelector(`[data-post-id="${postId}"]`).remove();
        });
}

// Reject one
function rejectOne(postId) {
    if (!confirm('Rechazar este borrador? Las fotos volveran a Clasificados.')) return;
    fetch(`/api/post/${postId}/reject`, {method: 'POST'})
        .then(r => r.json())
        .then(res => {
            document.querySelector(`[data-post-id="${postId}"]`).remove();
            if (res.photos_returned) {
                alert(`${res.photos_returned} foto(s) devueltas a Clasificados`);
            }
        });
}

// View post modal
let viewPostId = null;

function openViewModal(postId) {
    viewPostId = postId;
    const card = document.querySelector(`[data-post-id="${postId}"]`);
    const strip = document.getElementById(`strip-${postId}`);
    const imgs = strip.querySelectorAll('.photo-wrapper img');

    // Build photo grid
    const photosContainer = document.getElementById('view-modal-photos');
    photosContainer.innerHTML = [...imgs].map(img =>
        `<img src="${img.src}" alt="">`
    ).join('');

    // Set location
    document.getElementById('view-modal-location').textContent =
        card.querySelector('.location').textContent;

    // Set caption and hashtags
    document.getElementById('view-modal-caption').value =
        card.querySelector('.caption-area').value;
    document.getElementById('view-modal-hashtags').value =
        card.querySelector('.hashtags-area').value;

    // Show/hide split button
    const splitBtn = document.getElementById('view-split-btn');
    if (imgs.length >= 6) {
        splitBtn.style.display = 'inline-block';
    } else {
        splitBtn.style.display = 'none';
    }

    document.getElementById('view-modal').classList.add('visible');
    document.body.style.overflow = 'hidden';
}

function closeViewModal() {
    document.getElementById('view-modal').classList.remove('visible');
    document.body.style.overflow = '';
    viewPostId = null;
}

function saveViewCaption() {
    const text = document.getElementById('view-modal-caption').value;
    fetch(`/api/post/${viewPostId}/caption`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({text})
    }).then(() => {
        // Sync with card
        const card = document.querySelector(`[data-post-id="${viewPostId}"]`);
        card.querySelector('.caption-area').value = text;
    });
}

function saveViewHashtags() {
    const text = document.getElementById('view-modal-hashtags').value;
    const tags = text.split(/\s+/).filter(t => t.startsWith('#'));
    fetch(`/api/post/${viewPostId}/caption`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({hashtags: tags})
    }).then(() => {
        // Sync with card
        const card = document.querySelector(`[data-post-id="${viewPostId}"]`);
        card.querySelector('.hashtags-area').value = tags.join(' ');
    });
}

function approveFromView() {
    if (!confirm('Aprobar este post?')) return;
    fetch(`/api/post/${viewPostId}/approve`, {method: 'POST'})
        .then(r => r.json())
        .then(() => {
            closeViewModal();
            document.querySelector(`[data-post-id="${viewPostId}"]`).remove();
        });
}

function rejectFromView() {
    if (!confirm('Rechazar este borrador? Las fotos volveran a Clasificados.')) return;
    fetch(`/api/post/${viewPostId}/reject`, {method: 'POST'})
        .then(r => r.json())
        .then(() => {
            closeViewModal();
            document.querySelector(`[data-post-id="${viewPostId}"]`).remove();
        });
}

async function regenerateCaptionFromView() {
    if (!confirm('Regenerar caption con IA? El caption actual se perderÃ¡.')) return;

    try {
        const res = await fetch(`/api/post/${viewPostId}/regenerate-caption`, {method: 'POST'});
        const data = await res.json();

        if (data.ok) {
            // Update modal
            document.getElementById('view-modal-caption').value = data.caption;
            document.getElementById('view-modal-hashtags').value = data.hashtags.join(' ');

            // Sync with card
            const card = document.querySelector(`[data-post-id="${viewPostId}"]`);
            card.querySelector('.caption-area').value = data.caption;
            card.querySelector('.hashtags-area').value = data.hashtags.join(' ');

            alert('Caption regenerado!');
        } else {
            alert('Error: ' + data.error);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// Close view modal on Escape
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && viewPostId) closeViewModal();
});

// Split post with selection modal
let splitPostId = null;
let splitPhotos = [];
let selectedForNewPost = new Set();

function openSplitModal(postId) {
    splitPostId = postId;
    selectedForNewPost.clear();

    // Get photos from the strip
    const strip = document.getElementById(`strip-${postId}`);
    const imgs = strip.querySelectorAll('.photo-wrapper img');
    splitPhotos = [...imgs].map(img => ({
        filename: img.dataset.filename,
        src: img.src
    }));

    // Build photo grid
    const container = document.getElementById('split-photos');
    container.innerHTML = splitPhotos.map((p, i) => `
        <div class="split-photo" data-filename="${p.filename}" onclick="toggleSplitPhoto(this)">
            <img src="${p.src}">
            <span class="photo-label">${i + 1}</span>
        </div>
    `).join('');

    updateSplitSummary();
    document.getElementById('split-modal').classList.add('visible');
}

function closeSplitModal() {
    document.getElementById('split-modal').classList.remove('visible');
    splitPostId = null;
    splitPhotos = [];
    selectedForNewPost.clear();
}

function toggleSplitPhoto(el) {
    const filename = el.dataset.filename;
    if (selectedForNewPost.has(filename)) {
        selectedForNewPost.delete(filename);
        el.classList.remove('selected');
    } else {
        selectedForNewPost.add(filename);
        el.classList.add('selected');
    }
    updateSplitSummary();
}

function updateSplitSummary() {
    const total = splitPhotos.length;
    const moveCount = selectedForNewPost.size;
    const keepCount = total - moveCount;

    document.getElementById('split-keep').textContent = keepCount;
    document.getElementById('split-move').textContent = moveCount;

    const warning = document.getElementById('split-warning');
    const btn = document.getElementById('split-confirm-btn');

    if (keepCount < 3 || moveCount < 3) {
        warning.style.display = 'block';
        btn.disabled = true;
        btn.style.opacity = '0.5';
    } else {
        warning.style.display = 'none';
        btn.disabled = false;
        btn.style.opacity = '1';
    }
}

function confirmSplit() {
    if (selectedForNewPost.size < 3) return;

    const photosToMove = [...selectedForNewPost];

    fetch(`/api/post/${splitPostId}/split-select`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({photos_to_move: photosToMove})
    })
    .then(r => r.json())
    .then(res => {
        if (res.ok) {
            closeSplitModal();
            alert(`Post dividido: ${res.original_photos} + ${res.new_post_photos} fotos.\nEl nuevo post necesita caption.`);
            location.reload();
        } else {
            alert('Error: ' + res.error);
        }
    });
}

// Bulk approve
function approveBulk() {
    const ids = [...document.querySelectorAll('.post-check:checked')].map(cb => cb.value);
    if (!ids.length) return alert('Selecciona al menos un post');
    if (!confirm(`Aprobar ${ids.length} post(s)?`)) return;
    fetch('/api/posts/approve-bulk', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({post_ids: ids})
    }).then(() => location.reload());
}

// Delete photo from carousel
function deletePhoto(postId, filename) {
    const strip = document.getElementById(`strip-${postId}`);
    const photoCount = strip.querySelectorAll('.photo-wrapper').length;
    if (photoCount <= 1) {
        alert('No puedes eliminar la ultima foto. Usa "Rechazar" para eliminar el post completo.');
        return;
    }
    if (!confirm('Quitar esta foto del carrusel? (volvera a Clasificados)')) return;
    fetch(`/api/post/${postId}/photo/${filename}`, {method: 'DELETE'})
        .then(r => r.json())
        .then(res => {
            if (res.ok) {
                // Remove from DOM and renumber
                const wrapper = strip.querySelector(`img[data-filename="${filename}"]`).parentElement;
                wrapper.remove();
                // Update filenames after deletion
                const imgs = [...strip.querySelectorAll('img')];
                imgs.forEach((img, idx) => {
                    const newName = String(idx + 1).padStart(2, '0') + '.jpg';
                    img.dataset.filename = newName;
                    img.src = `/api/photo/${postId}/${newName}?t=${Date.now()}`;
                });
                // Update photo count
                const countEl = strip.closest('.post-card').querySelector('.photo-count');
                countEl.textContent = imgs.length + ' fotos';
            }
        });
}

// Drag & drop reorder for photos
document.querySelectorAll('.photos-strip').forEach(strip => {
    let dragSrc = null;
    let dragWrapper = null;
    strip.querySelectorAll('.photo-wrapper img').forEach(img => {
        img.addEventListener('dragstart', function(e) {
            dragSrc = this;
            dragWrapper = this.parentElement;
            this.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        });
        img.addEventListener('dragend', function() {
            this.classList.remove('dragging');
        });
        img.addEventListener('dragover', function(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        });
        img.addEventListener('drop', function(e) {
            e.preventDefault();
            if (dragSrc !== this) {
                const parent = strip;
                const targetWrapper = this.parentElement;
                const allWrappers = [...parent.querySelectorAll('.photo-wrapper')];
                const fromIdx = allWrappers.indexOf(dragWrapper);
                const toIdx = allWrappers.indexOf(targetWrapper);
                if (fromIdx < toIdx) {
                    parent.insertBefore(dragWrapper, targetWrapper.nextSibling);
                } else {
                    parent.insertBefore(dragWrapper, targetWrapper);
                }
                // Save new order
                const postId = parent.id.replace('strip-', '');
                const order = [...parent.querySelectorAll('.photo-wrapper img')].map(i => i.dataset.filename);
                fetch(`/api/post/${postId}/reorder`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({order})
                }).then(r => r.json()).then(res => {
                    if (res.ok) {
                        // Update data-filename and src to match new numbering
                        const imgs = [...parent.querySelectorAll('.photo-wrapper img')];
                        imgs.forEach((img, idx) => {
                            const newName = String(idx + 1).padStart(2, '0') + '.jpg';
                            img.dataset.filename = newName;
                            img.src = `/api/photo/${postId}/${newName}?t=${Date.now()}`;
                        });
                    }
                });
            }
        });
    });
});
</script>
{% endblock %}
